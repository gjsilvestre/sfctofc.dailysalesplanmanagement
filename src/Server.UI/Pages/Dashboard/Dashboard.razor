@page "/"

@* @using SFCTOFC.DailySalesPlanManagement.Application.Features.SalesmanDailyPlan.Commands *@
@using SFCTOFC.DailySalesPlanManagement.Application.Features.SalesmanDailyPlan.Commands
@using SFCTOFC.DailySalesPlanManagement.Application.Features.SalesmanDailyPlan.Queries
@using SFCTOFC.DailySalesPlanManagement.Infrastructure.Persistence
@using SFCTOFC.DailySalesPlanManagement.Server.UI.Pages.Dashboard.Components
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Security
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Interfaces.Identity
@using SFCTOFC.DailySalesPlanManagement.Application.Common.Interfaces
@using SFCTOFC.DailySalesPlanManagement.Application.Features.Tenants.DTOs
@using MudBlazor.Utilities

@using SFCTOFC.DailySalesPlanManagement.Application.Features.DSPM.DTOs;
@using SFCTOFC.DailySalesPlanManagement.Application.Features.DSPM.Queries.Pagination;
@using System.Diagnostics

@inject IStringLocalizer<Dashboard> L
@inject IUserProfileState UserProfileState
@inject ITenantSwitchService TenantSwitchService
@using System.Globalization
@inject IDbContextFactory<ApplicationDbContext> _dbContextFactory

<style>

    @@import url("https://cdn.jsdelivr.net/npm/@@fancyapps/ui@@5.0.36/dist/fancybox/fancybox.css");

    .fancybox__container {
        --fancybox-bg: rgba(24, 24, 27, 0.85);
        z-index: 9999;
    }


    html, body {
        -moz-osx-font-smoothing: grayscale; /* Firefox on macOS */
        -webkit-font-smoothing: antialiased; /* Chrome, Edge, Safari */
        text-rendering: optimizeLegibility;
    }

    body {
        font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
        font-size: 12px;
    }

    .mud-menu .mud-icon-button {
        border-radius: 0 !important;
    }

    .search .mud-input {
        line-height: 1px !important;
    }

    .small-input .mud-input-slot {
        min-height: 28px !important;
        font-size: 0.8rem !important;
    }

    .small-input input {
        padding: 2px 6px !important;
    }



    .mud-input-control > .mud-input-control-input-container > .mud-input-label-inputcontrol {
        font-size: 1rem !important;
        font-weight: 600;
    }

    .mud-table.mud-data-grid .mud-table-toolbar {
        padding: 0rem !important;
    }

    .mud-table-root {
        margin-top: 1.3ewm !important;
    }

    .mud-table thead th {
        /* background-color: #c3c3c3 !important; */
        /* background-color: #dddddd !important;  */
        color: black !important;
        font-weight: 600;
        /* border: 1px solid #ccc; */
        /* border-top: 1px solid #eaeaea; */
    }



    .force-row {
        display: flex !important;
        flex-direction: row !important;
    }

    .gap-20 {
        column-gap: 190px;
    }

    .gap-21 {
        column-gap: 207px;
    }

    .gap-22 {
        column-gap: 140px;
    }

    .gap-19 {
        /* column-gap: 159px; */
    }


    .mud-table-bordered th,
    .mud-table-bordered td {
        align-content: flex-start;
        border: 1px solid #E3E3E3;
        padding: 6px;
    }

    .mud-table-bordered {
        border-collapse: collapse;
        width: 100%;
    }

    .compact-padding {
        padding: 9px 16px 0px 16px;
    }


    .ultra-compact-grid .mud-table-row {
        height: 26px !important;
    }

    .ultra-compact-grid .mud-table-cell {
        padding: 2px 6px !important;
        font-size: 0.75rem !important;
    }

    .mud-data-grid .mud-table-foot {
        display: none !important;
    }


    .mud-table.mud-table-striped tbody tr:nth-child(odd) {
        background-color: #fafafa !important;
    }

    .mud-table.mud-table-striped tbody tr:nth-child(even) {
        background-color: #ebebeb !important;
    }


    .mud-table.mud-table-hover tbody tr:hover {
        background-color: #00baef !important;
        color: white;
        cursor: pointer;
    }

    .mud-datagrid-header {
        border-bottom: 1px solid #E6E6E6;
    }

    .mud-datagrid-pager .mud-select {
        margin-left: auto !important;
    }



    .custom-pager .mud-datagrid-pager {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
    /* daya here for top spacing mawala lang sa page nato*/

    .mud-main-content {
        padding-top: 25px !important;
    }

    .mud-drawer-header {
        display: flex !important;
        min-height: 0px !important;
        padding: 0px 0px 0px 0px !important;
        padding-left: 15px !important;
        padding-top: 10px !important;
        min-height: 2px !important;
    }
</style>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">

<PageTitle>@Title</PageTitle>

<ErrorBoundary>
    <MudCard>
        <MudCardContent>
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-7 mt-7">
                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.CoPresent" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h3" Style="color: black;">
                        Welcome, <span style="color: orangered;">@UserProfile?.DisplayName</span>!
                    </MudText>
                </MudStack>
            </MudStack>
        </MudCardContent>
    </MudCard>

    <DashboardSalesmanActivity TotalTargetSales="TotalTargetSales"
                               TotalActualSales="TotalActualSales"
                               TotalTargetStores="TotalTargetStores"
                               TotalActualStores="TotalActualStores" />


    <MudDataGrid T="SalesmanDailyPlansDto"
                 Class="ultra-compact-grid compact-padding mud-datagrid-header" 
                 ServerData="@(ServerReload)" 
                 RowClick="OnRowClick"
                 FixedHeader="true" 
                 FixedFooter="false" 
                 Loading="@_loading" 
                 ColumnResizeMode="ResizeMode.Column" 
                 Striped="true" 
                 Dense="true" 
                 Hover="true" 
                 @ref="_dataGridSalesmanTracket" 
                 RowsPerPage="20" 
                 Style="height:100%; overflow:auto;">
        <ToolBarContent>
            <MudStack Row Spacing="0" Class="flex-grow-1 mb-5" Justify="Justify.SpaceBetween">
                <MudStack Row AlignItems="AlignItems.End">
                    <MudStack Spacing="0">
                        <div style="width: fit-content; margin: 0 auto;">
                            <MudStack Row Spacing="0" Class="force-row" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h5" Class="mb-2 fw-bold"><b>Todays Plan</b></MudText>

                                <MudToolBar Dense WrapContent="true" Class="py-1 px-0">
                                    @* <MudDatePicker Label="Date" Class="ml-4" Margin="Margin.Dense" Variant="Variant.Outlined" /> *@
                                    <MudDatePicker @bind-Date="selectedDate" />
                                </MudToolBar>
                            </MudStack>
                        </div>
                    </MudStack>
                </MudStack>
                <MudStack Row AlignItems="AlignItems.Start">
                    <MudStack Spacing="0">
                        @* <MudText Typo="Typo.h3" Class="mb-2 fw-bold"><b>Salesman Activities</b></MudText> *@
                        <div style="width: fit-content;">
                            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                @* SEACH FIELD *@
                                <MudTextField T="string"
                                              Variant="Variant.Outlined"
                                              Dense="true"
                                              Class="search small-input mt-3 mb-4 mr-5"
                                              @bind-Value="_paginationQuery.Keyword"
                                              Placeholder="@ConstantString.Search"
                                              Adornment="Adornment.End"
                                              AdornmentIcon="@Icons.Material.Filled.Search"
                                              IconSize="Size.Small"
                                              Immediate="true"
                                              Clearable="true">
                                </MudTextField>

                                <MudTooltip Text="Refresh Dashboard">
                                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                                   Color="Color.Primary"
                                                   Size="Size.Small" />
                                </MudTooltip>
                            </MudStack>
                        </div>
                    </MudStack>
                </MudStack>
            </MudStack>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.UserName" Title="Salesman" />
            <PropertyColumn Property="x => x.OutletCount" Title="No. of Outlets" />

            <TemplateColumn Title="Target Sales">
                <CellTemplate Context="x">
                    ₱ @string.Format("{0:N2}", x.Item.TargetSales)
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Actual Sales">
                <CellTemplate Context="x">
                    ₱ @string.Format("{0:N2}", x.Item.ActualSales)
                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.CheckedInCount" Title="Visited" />
            <PropertyColumn Property="x => x.SkippedCount" Title="Skipped" />
        </Columns>


        <NoRecordsContent>
            <MudText>@ConstantString.NoRecords</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>@ConstantString.Loading</MudText>
        </LoadingContent>
        <PagerContent>
            <MudDataGridPager PageSizeOptions="@(new[] { 10, 20, 30, 50 })" Class="custom-pager" />
        </PagerContent>
    </MudDataGrid>

    <MudDrawer Anchor="Anchor.Right"
           @bind-Open="_showDrawer"
           Elevation="5"
           Width="70%"
           Variant="DrawerVariant.Temporary">
        <!-- HEADER (fixed) -->
        <MudDrawerHeader Class="px-4 py-3 sticky-header mt-3">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <MudText Typo="Typo.h5" Class="fw-bold">
                    @_selectedSalesmanName – Outlets
                </MudText>

                <MudIconButton Icon="@Icons.Material.Filled.Close"
                               OnClick="() => _showDrawer = false" />
            </div>
        </MudDrawerHeader>



        <MudCardContent Class="p-4 drawer-body mt-2">
            <MudStack Row Justify="Justify.FlexEnd" Class="mb-3" Spacing="2">

                @if (!_isEditAll)
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Edit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="EnableEditAll">
                        Edit All
                    </MudButton>
                }
                else
                {
                    <MudButton StartIcon="@Icons.Material.Filled.Check"
                               Color="Color.Success"
                               OnClick="SaveAllTargets">
                        Save All
                    </MudButton>

                    <MudButton StartIcon="@Icons.Material.Filled.Close"
                               Variant="Variant.Outlined"
                               Color="Color.Error"
                               OnClick="CancelAllEdit">
                        Cancel
                    </MudButton>
                }

            </MudStack>

    @if (_selectedOutlets.Any())
    {
        <MudTable Items="_selectedOutlets" Dense="true" Hover="true" Bordered="false" Striped="true" Elevation="0">

            <HeaderContent>
                <MudTh>Outlet</MudTh>
                <MudTh align="right">Target</MudTh>
                <MudTh align="right">Actual</MudTh>
                <MudTh align="center">Status</MudTh>
                @* <MudTh align="center">Edit</MudTh> *@

            </HeaderContent>

                    <RowTemplate>
                        <MudTd DataLabel="Outlet" Class="fw-bold">
                            @context.OutletName
                        </MudTd>

                        <MudTd DataLabel="Target" Align="Align.Right">
                            @if (_isEditAll)
                            {
                                <MudTextField @bind-Value="context.TargetSales"
                                              Variant="Variant.Outlined"
                                              Size="Size.Small"
                                              Immediate="true" />
                            }
                            else
                            {
                                @string.Format("{0:N2}", context.TargetSales)
                            }
                        </MudTd>

                      

                        <MudTd DataLabel="Actual" Align="Align.Right">
                            ₱ @string.Format("{0:N2}", context.ActualSales)
                        </MudTd>

                        <MudTd DataLabel="Status" Align="Align.Center">
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.ColorStatus)">
                                @context.ColorStatus
                            </MudChip>
                        </MudTd>

                 

                    </RowTemplate>


        </MudTable>
    }
    else
    {
        <MudText Align="Align.Center" Color="Color.Error" Class="mt-6">
            NO DATA FOUND
        </MudText>
    }

</MudCardContent>

</MudDrawer>

</ErrorBoundary>
@code {


    public string Title { get; set; } = "Salesman Activities";
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;
    [CascadingParameter] private UserProfile? UserProfile { get; set; }
    private ProductsAccessRights _accessRights = new();
    private PaginationQuerySalesmanTracker _paginationQuery { get; } = new();
    private bool _loading;
    private decimal? TotalTargetSales { get; set; }
    private decimal? TotalActualSales { get; set; }
    private int TotalTargetStores { get; set; }
    private int TotalActualStores { get; set; }
    private int? _editTargetId = null;
    bool _isEditAll = false;
    void EnableEditAll()
    {
        _isEditAll = true;
    }

    async Task SaveAllTargets()
    {
        _isEditAll = false;

        foreach (var outlet in _selectedOutlets)
        {
            await SaveTarget(outlet);
        }
    }

    void CancelAllEdit()
    {
        _isEditAll = false;
        StateHasChanged();
    }

    private void EditTarget(int id)
    {
        _editTargetId = id;
    }

    private void CancelEdit()
    {
        _editTargetId = null;
    }

    private async Task SaveTarget(SalesmanDailyPlansDto plan)
    {
        try
        {
            var result = await Mediator.Send(new UpdateTargetSalesCommand
            {
                Id = plan.Id,
                TargetSales = plan.TargetSales ?? 0
            });
            if (true)
            {
                _editTargetId = null;
                _selectedOutlets = await Mediator.Send(
                    new GetSalesmanOutletsQuery(_selectedSalesmanName, _paginationQuery.Date));
            }
            else
            {
                Console.WriteLine("Failed to update target sales.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving target: {ex.Message}");
        }
    }


    private List<SalesmanDailyPlansDto> _List = new();
    private MudDataGrid<SalesmanDailyPlansDto> _dataGridSalesmanTracket = default!;
    // private DateTime? _selectedDate = DateTime.Today;

    private DateTime? _selectedDate = DateTime.Today;
    private DateTime? selectedDate
    {
        get => _selectedDate;
        set
        {
            if (_selectedDate != value)
            {
                _selectedDate = value;
                _paginationQuery.Date = value;
                _ = _dataGridSalesmanTracket.ReloadServerData();
            }
        }
    }
    Color GetStatusColor(string status)
    {
        return status switch
        {
            "Checked Out" => Color.Success,
            "Checked In" => Color.Info,
            "Skipped" => Color.Error,
            "Not Yet Started" => Color.Warning,
            _ => Color.Default
        };
    }

    private bool _showDrawer;
    private string _selectedSalesmanName = "";
    private List<SalesmanDailyPlansDto> _selectedOutlets = new();
    private SalesmanDailyPlansDto _viewPlan = new();


    private async Task OnRowClick(DataGridRowClickEventArgs<SalesmanDailyPlansDto> args)
    {
        _viewPlan = args.Item;
        _selectedSalesmanName = _viewPlan.UserName;

        _selectedOutlets = await Mediator.Send(
         new GetSalesmanOutletsQuery(
             _viewPlan.UserName,
             _paginationQuery.Date
             )
         );

        Console.WriteLine($"RETURNED {_selectedOutlets.Count} OUTLETS");

        _showDrawer = true;

    }


    private Color GetStatusColor(SalesmanDailyPlansDto data)
    {
        if (data.CheckedIn.HasValue && data.CheckedOut.HasValue)
            return Color.Success;

        if (data.CheckedIn.HasValue)
            return Color.Info;

        if (data.Skipped.HasValue)
            return Color.Error;

        return Color.Warning;
    }




    private string GetStatusText(SalesmanDailyPlansDto data)
    {
        if (data.CheckedIn.HasValue && data.CheckedOut.HasValue)
            return "Checked Out";

        if (data.CheckedIn.HasValue)
            return "Checked In";

        if (data.Skipped.HasValue)
            return "Skipped";

        return "Unbegun";
    }




    private async Task OnDateChanged(DateTime? date)
    {
        _paginationQuery.Date = date;
        await _dataGridSalesmanTracket.ReloadServerData();
    }

    private async Task ReloadGridByDate()
    {
        _paginationQuery.Date = selectedDate;
        await _dataGridSalesmanTracket.ReloadServerData();
    }


    protected override void OnInitialized()
    {
        UserProfileState.Changed += OnUserProfileChanged;
        base.OnInitialized();
    }

    protected override async Task OnInitializedAsync()
    {
        UserProfileState.Changed += OnUserProfileChanged;
        _paginationQuery.Date = selectedDate;
    }

    public void Dispose()
    {
        UserProfileState.Changed -= OnUserProfileChanged;
    }

    private void OnUserProfileChanged(object? sender, UserProfile userProfile)
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task<GridData<SalesmanDailyPlansDto>> ServerReload(GridState<SalesmanDailyPlansDto> state)
    {
        try
        {
            _loading = true;
            _paginationQuery.CurrentUser = UserProfile;
            _paginationQuery.OrderBy = state.SortDefinitions.FirstOrDefault()?.SortBy ?? "Id";
            _paginationQuery.SortDirection = state.SortDefinitions.FirstOrDefault()?.Descending ?? true
                                              ? SortDirection.Descending.ToString()
                                              : SortDirection.Ascending.ToString();
            _paginationQuery.PageNumber = state.Page + 1;
            _paginationQuery.PageSize = state.PageSize;

            var result = await Mediator.Send(_paginationQuery).ConfigureAwait(false);
            Debug.WriteLine("DEBUG: ", result);
            _List = result.Items?.ToList() ?? new List<SalesmanDailyPlansDto>();

            TotalTargetSales = _List.Sum(x => x.TargetSales);
            TotalActualSales = _List.Sum(x => x.ActualSales);
            TotalTargetStores = _List.Sum(x => x.OutletCount);
            TotalActualStores = _List.Sum(x => x.CheckedInCount);

            return new GridData<SalesmanDailyPlansDto> { TotalItems = result.TotalItems, Items = _List };
        }
        finally
        {
            _loading = false;
        }
    }
}
